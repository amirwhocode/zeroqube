# Start from the official Jupyter minimal notebook image
FROM jupyter/minimal-notebook:latest

USER root

# Install nbgrader and ngshare-exchange
# nbgrader is the grading system, ngshare_exchange is the component that connects to ngshare
RUN pip install --no-cache-dir \
    nbgrader \
    ngshare_exchange

# Enable the necessary Jupyter extensions
# These extensions provide UI elements for nbgrader and ngshare
RUN jupyter serverextension enable --py --system nbgrader && \
    jupyter serverextension enable --py --system ngshare_exchange && \
    jupyter nbextension install --py --system nbgrader --overwrite && \
    jupyter nbextension enable --py --system nbgrader && \
    jupyter nbextension enable --py --system assignment_list && \
    jupyter nbextension enable --py --system course_list && \
    jupyter nbextension enable --py --system validate_assignment

# Create necessary directories and fix permissions
RUN mkdir -p /home/jovyan/.jupyter && \
    chmod -R 777 /home/jovyan/.jupyter

# Switch back to the jovyan user
USER jovyan

# Create a basic nbgrader configuration that works with ngshare
RUN echo "c.Exchange.service_url = 'http://ngshare:8080/services/ngshare'" > /home/jovyan/.jupyter/nbgrader_config.py && \
    echo "c.Exchange.exchange_directory = '/tmp/exchange'" >> /home/jovyan/.jupyter/nbgrader_config.py && \
    echo "c.Exchange.path_includes_course = True" >> /home/jovyan/.jupyter/nbgrader_config.py && \
    echo "c.Exchange.timezone = 'UTC'" >> /home/jovyan/.jupyter/nbgrader_config.py